{"name":"Lumi Process","type":"virtual_device","properties":{"deviceIcon":0,"currentIcon":"0","log":"","logTemp":"","mainLoop":"","visible":"true","rows":[{"type":"button","elements":[{"id":1,"lua":true,"waitForResponse":false,"caption":"Process","name":"Button11","empty":false,"msg":"local selfId = fibaro:getSelfId();\nsodevice=tonumber(fibaro:getValue(selfId,'TCPPort'))\nip=fibaro:getValue(selfId,'IPAddress')\ntrangthaitt={\n  [1]=\"a\",\n}\n------------------------\n-- Ham chi dung cho nut OFF\nfunction bxor(a, b) local x,i,r;r=0; for i = 0, 31 do x = a / 2 + b / 2; if (x~=math.floor(x)) then r = r + 2^i; end a = math.floor(a / 2); b = math.floor(b / 2); end return r; end\nfunction checkSum1(t) local i,b,c;c=0; for i = 1, #t do b = string.byte(t, i); if (c==0) then c = b; else c = bxor(c, b); end if (i>100) then break; end end return c; end\nfunction DEC_HEX(IN) local B,K,OUT,I,D=16,\"0123456789ABCDEF\",\"\",0 while IN>0 do I=I+1 IN,D=math.floor(IN/B),math.mod(IN,B)+1 OUT=string.sub(K,D,D)..OUT end return OUT end\nfunction num2hex(num) local hexstr = '0123456789abcdef' local s = '' while num > 0 do local mod = math.fmod(num, 16) s = string.sub(hexstr, mod+1, mod+1) .. s num = math.floor(num / 16) end if s == '' then s = '0' end return s end\nfunction str2hex(str) local hex = '' while #str > 0 do local hb = num2hex(string.byte(str, 1, 1)) if #hb < 2 then hb = '0' .. hb end hex = hex .. hb str = string.sub(str, 2) end return hex end\nfunction str2hex_(str) local hex = '' while #str > 0 do local hb = num2hex(string.byte(str, 1, 1)) if #hb < 2 then hb = '0' .. hb end hex = hex .. hb .. \"-\" str = string.sub(str, 2) end return hex end\n\nfunction returnlogin(hex) end\nfunction chuyendoi(num) OFF=0 if chedo==\"ON\" then if num==1 then OFF=0x02 elseif num==2 then OFF=0x08 elseif num==3 then OFF=0x20 elseif num==4 then OFF=0x80 end elseif num==1 then OFF=0x01 elseif num==2 then OFF=0x04 elseif num==3 then OFF=0x10 elseif num==4 then OFF=0x40 end return OFF end\nfunction checksum_data(data) check=checkSum1(data .. string.char(0x0d)) check=\"0x\" .. num2hex(check) data = data .. string.char(check) return data end\n\nOFF=chuyendoi(num)\n--Truyen login\nlogin = string.char(0x18, 0x02, 0x01, 0x05, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x42, 0x00, 0x5c, 0x01, 0x08, 0x61, 0x64, 0x6d, 0x69, 0x6e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x65, 0x31, 0x30, 0x61, 0x64, 0x63, 0x33, 0x39, 0x34, 0x39, 0x62, 0x61, 0x35, 0x39, 0x61, 0x62, 0x62, 0x65, 0x35, 0x36, 0x65, 0x30, 0x35, 0x37, 0x66, 0x32, 0x30, 0x66, 0x38, 0x38, 0x33, 0x65)\ntcpSocket = Net.FTcpSocket(ip,8686)\ntcpSocket:setReadTimeout(1000)\nbytes, errorCode = tcpSocket:write(login);\nstate = tcpSocket:read()\n--tach user\nstate3=string.sub(state,5,12)\n--nhan ma id tu SOhieu\nlocal i=0\ntraloi=string.char(0x18, 0x02, 0x01, 0x05).. state3 .. state3 .. string.char(0x01, 0x00, 0x02, 0x00, 0x1d, 0x01, 0x04)\nbytes, errorCode = tcpSocket:write(traloi);\nstate = tcpSocket:read()\nlaytt=string.char(0x18, 0x02, 0x01, 0x05).. state3 .. state3 .. string.char(0x01, 0x00, 0x02, 0x00, 0x1d, 0x11, 0x05)\n\nbytes, errorCode = tcpSocket:write(laytt); \nstate = tcpSocket:read()\nfibaro:debug(\"STATE \" .. str2hex(state))\nfor i=1,sodevice do\n    vitri=34+(8*(i-1))\n    trangthaitt[i]=string.sub(state,vitri,vitri+3)\n    --fibaro:debug(str2hex(trangthaitt[i]))\nend\nfibaro:setGlobal(\"Lumi\", json.encode(trangthaitt))","buttonIcon":0,"favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}