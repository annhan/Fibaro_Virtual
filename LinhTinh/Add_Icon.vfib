{"name":"Add Icon","type":"virtual_device","properties":{"deviceIcon":1141,"currentIcon":"1141","log":"","logTemp":"","mainLoop":"","ui.Label1.value":"","ui.Label2.value":"","ui.Label3.value":"","ui.Label4.value":"","visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"Virtual Device","name":"Label1","favourite":false,"main":false}]},{"type":"button","elements":[{"id":2,"lua":true,"waitForResponse":false,"caption":"Add","name":"Button51","empty":false,"msg":"--------------------\n--- mHome ---------------\n--Phamj An Nhan -------------\n--  Warning: the Code will delete all User icon in Virtual Device-\n------------------------------------------------------\n\nUSER = \"Kythuat@kimsontien.com\" --User HC2\nPASSWORD = \"xxxxxxxxxxxx\"    --Password HC2\n---------------------------------------------\nlocal http=\"kimsontien.ddns.net\"\nlocal Link_ICON = {\n  [1] = \"/download.php?file=icon/CS/1.png\",\n  [2] = \"/download.php?file=icon/CS/2.png\",\n  [3] = \"/download.php?file=icon/CS/3.png\",\n  [4] = \"/download.php?file=icon/AnNinh/1%20ON.png\",\n  [5] = \"/download.php?file=icon/AnNinh/1%20OFF.png\",\n  [6] = \"/download.php?file=icon/AnNinh/1%20Unk.png\",\n  [7] = \"/download.php?file=icon/AnNinh/1%20War.png\",\n  [8] = \"/download.php?file=icon/AnNinh/Sim/1.png\",\n  [9] = \"/download.php?file=icon/AnNinh/Sim/2.png\",\n  [10] = \"/download.php?file=icon/AnNinh/Sim/8.png\",\n [11] = \"/download.php?file=icon/AnNinh/AmThanh/1.png\",\n  [12] = \"/download.php?file=icon/AnNinh/AmThanh/2.png\",\n  [13] = \"/download.php?file=icon/AnNinh/AmThanh/3.png\",\n  [14] = \"/download.php?file=icon/AnNinh/AmThanh/4.png\",\n  [15] = \"/download.php?file=icon/AnNinh/Camera/1.png\",\n  [16] = \"/download.php?file=icon/HenGio/1.png\",\n  [17] = \"/download.php?file=icon/HenGio/2.png\",\n  [18] = \"/download.php?file=icon/HenGio/3.png\",\n  \n}\n\n--------------------------------------------------------------\n----- Lock Code ---------------------------------------------\n-----------------------------------------------------------\nlocal varName = {\n  [\"ICON_VIRTUAL\"] = {\n    value = \"0\",\n    type = \"simple\"\n  }\n}\n\nfunction checkGlobalVariable(varName)\n-- Check if variable exist \nlocal HC2 = Net.FHttp(\"127.0.0.1\", 11111);\nfor i , v in pairs(varName) do\n\t\tresponse ,status, errorCode = HC2:POST(\"/api/globalVariables/\"..i, json.encode({\n      \tname = i,\n      \tvalue = v.value,\n      \tisEnum = 1,\n      \tenumValues = {}\n    })\n);\nif status == \"200\" or status == \"201\" then\n\n  \t\tfibaro:sleep(800);\n  \t\tresponse ,status, errorCode = HC2:PUT(\"/api/globalVariables/\"..i, json.encode({\n        name = i,\n        value = v.value,\n        isEnum = false,\n        enumValues = {}\n      })\n  );\n  \tif status == \"200\" or status == \"201\" then\n    \tfibaro:debug(\"Gloabal '\" ..i.. \"' Value : '\" ..v.value.. \"'  Creating Success.\");\n  \telse\n    \tfibaro:debug(\"Uppdate - Error : \" ..status);\n  \tend\nelse\n  \tfibaro:debug(\"Gloabal \"..i.. \" available - Error : \" ..status);\nend\nend\nupdateVar = true\nend\n\n\nfunction encode(data) local b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'; return ((data:gsub('.', function(x) local r,b='',x:byte() for i=8,1,-1 do r=r..(b%2^i-b%2^(i-1)>0 and '1' or '0') end return r; end)..'0000'):gsub('%d%d%d?%d?%d?%d?', function(x) if (#x < 6) then return '' end local c=0 for i=1,6 do c=c+(x:sub(i,i)=='1' and 2^(6-i) or 0) end return b:sub(c+1,c+1) end)..({ '', '==', '=' })[#data%3+1]) end \nfunction random(nums) local i,r;r=\"\";for i=1,nums do r=r..tostring(math.random(0,9)); end; return r; end\nfunction checkSum(t) local i,b,c;c=0; for i = 1, #t do b = string.byte(t, i); if (c==0) then c = b; else c = bxor(c, b); end if (i>100) then break; end end return c; end\nfunction bxor(a, b) local x,i,r;r=0; for i = 0, 31 do x = a / 2 + b / 2; if (x~=math.floor(x)) then r = r + 2^i; end a = math.floor(a / 2); b = math.floor(b / 2); end return r; end\n\nfunction uploadIcon(login, pass, rawIcon)\n  tcp = Net.FTcpSocket(\"localhost\", 80);\n  if (not tcp) then\n    fibaro:debug(\"TCP CONNECTING WITH HC2 ERROR!\");\n    return nil;\n  end\n  boundary = \"WebKitFormBoundary3ZD59n5AN4R94fws\";\n  enter = \"\\r\\n\";\n  content = \n    \"------\" .. boundary .. enter ..\n    \"Content-Disposition: form-data; name=\\\"type\\\"\" .. enter ..\n    enter ..\n    \"virtualDevice\" .. enter ..\n    \"------\" .. boundary .. enter ..\n    \"Content-Disposition: form-data; name=\\\"redirect\\\"\" .. enter ..\n\tenter ..\n  \t\"fibaro/en/devices/icons.html?id=1&type=virtualDevice\"..enter ..\n\t\"------\" .. boundary .. enter ..\n    \"Content-Disposition: form-data; name=\\\"icon0\\\"; filename=\\\"iconnhan.png\\\"\" .. enter ..\n    \"Content-Type: image/png\" .. enter ..\n    enter ..\n    rawIcon .. enter ..\n    \"------\" .. boundary .. \"--\" .. enter;\n  tcp:write(\"POST /api/icons HTTP/1.1\" .. enter);\n  tcp:write(\"Host: localhost\" .. enter);\n  tcp:write(\"Content-Length: \" .. string.len(content) .. enter);\n  tcp:write(\"Authorization: Basic \" .. encode(USER..\":\"..PASSWORD) .. enter);\n  tcp:write(\"Content-Type: multipart/form-data; boundary=----\" .. boundary .. enter .. enter);\n   s = 0; for i = 1, #content do\n    b, e = tcp:write(string.char(string.byte(content, i)));\n    s = s + b;\n  end\n  status, err = tcp:read();\n  --fibaro:debug(status)\n  fibaro:debug(\"Sended \" .. s .. \" content bytes with result [\" .. err .. \"].\");\n  -- if answer is wrong\n  if (tonumber(err)>0) then\n    return nil;\n  end\n  return 0;\nend\n\nfunction getIconId(tcp, rawIcon)\n  -- grab icons list from api\n  response, status, errorCode = tcp:GET(\"/api/icons\");\n  -- if answer is wrong\n  if (tonumber(status)~=200) then\n    return nil;\n  -- if answer is ok?\n  else\n    -- decode text to json object\n    jsonTable = json.decode(\"[\" .. response .. \"]\");\n    -- look at device\n    iconsArray = jsonTable[1].virtualDevice;\n    -- check all icons\n    for iconIndex, iconData in pairs(iconsArray) do\n      if (iconData.id>=1000) then\n        -- grab icon from HC2\n        r, s, e = tcp:GET(\"/fibaro/n_vicons/\" .. iconData.iconName .. \".png\");\n        if (s==\"200\" and e==0) then\n          --fibaro:debug('  Icon [' .. iconData.id .. '][' .. iconData.iconName .. '][' .. string.len(r) .. ' bytes]');\n          if (string.len(r)==string.len(rawIcon)) then\n            if (checkSum(r)==checkSum(rawIcon)) then\n              --fibaro:debug(\"FOUND [\" .. iconData.id .. \"]!\");\n              return iconData.id;\n            end\n          end\n        end\n      end\n    end\n  end\n  return 0;\nend\nDebug = function ( color, message )\n  fibaro:debug(string.format('<%s style=\"color:%s;\">%s</%s>', \"span\", color, message, \"span\")); \nend\n\n--Get ICON from Server\ncheckGlobalVariable(varName)\nlocal i=0;\nfor key,value in ipairs(Link_ICON) do\n  \tfibaro:debug(key)\n  \t--fibaro:debug(value)\n  \ttcpSERVER = Net.FHttp(http, 8080); \n\ticon=tcpSERVER:GET(value);\n  \t--fibaro:debug(icon)\n--Upload Icon\n\tuploadIcon(USER, PASSWORD, icon);\n-- Get ID ICON \n  \tif (i==0) then\n    \ti=1;\n\t\ttcpHC2 = Net.FHttp(\"localhost\", 80);\n\t\ttcpHC2:setBasicAuthentication(USER, PASSWORD);\n\t\tid = getIconId(tcpHC2, icon);\n\t\tfibaro:debug(\"First ID save in global ICON_VIRTUAL\".. id) \n    \tfibaro:setGlobal(\"ICON_VIRTUAL\", id)\n  \tend\n  \tfibaro:sleep(1000)\nend\nDebug( \"red\", \"Hoàn Thành\");\n--Icôn ON Lighting\n\n---------------------------------------------\n","buttonIcon":0,"favourite":false,"main":false},{"id":3,"lua":true,"waitForResponse":false,"caption":"Delete","name":"Button52","empty":false,"msg":"--------------------\n--- mHome ---------------\n--Phamj An Nhan -------------\n--  Warning: the Code will delete all User icon in Virtual Device-\n------------------------------------------------------\n\nUSER = \"Kythuat@kimsontien.com\" --User HC2\nPASSWORD = \"xxxxxxxxxxxx\"    --Password HC2\n---------------------------------------------\nfunction getIconId(tcp)\n  fibaro:debug(\"A\")\n  response, status, errorCode = tcp:GET(\"/api/icons\");\n  if (tonumber(status)~=200) then\n    return nil;\n  else\n    jsonTable = json.decode(\"[\" .. response .. \"]\");\n    iconsArray = jsonTable[1].virtualDevice;\n    for iconIndex, iconData in pairs(iconsArray) do\n      \tfibaro:debug(iconData.id)\n      if (iconData.id>=1000) then\n        r, s, e = tcp:DELETE(\"/api/icons?id=\"..iconData.id..\"&type=virtualDevice\");\n      end\n    end\n  end\nend\ntcpHC2 = Net.FHttp(\"localhost\", 80);\ntcpHC2:setBasicAuthentication(USER, PASSWORD);\ngetIconId(tcpHC2);","buttonIcon":0,"favourite":false,"main":false}]},{"type":"label","elements":[{"id":4,"lua":false,"waitForResponse":false,"caption":"LIGHTING","name":"Label2","favourite":false,"main":false}]},{"type":"button","elements":[{"id":5,"lua":true,"waitForResponse":false,"caption":"Add","name":"Button61","empty":false,"msg":"--------------------\n--- mHome ---------------\n--Phamj An Nhan -------------\n------------------------------------------------------\n\nUSER = \"Kythuat@kimsontien.com\" --User HC2\nPASSWORD = \"xxxxxxxxxxxx\"    --Password HC2\n--------------------------------------------\nlocal http=\"kimsontien.ddns.net\"\nlocal Link_ICON_DEN = {\n   [1] = {\n    \tON = '/download.php?file=icon/Den/Downlight/1ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Downlight/1OFF.png'\n  \t},\n   [2] = {\n    \tON = '/download.php?file=icon/Den/Downlight/2ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Downlight/2OFF.png'\n  \t},\n   [3] = {\n    \tON = '/download.php?file=icon/Den/Downlight/3ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Downlight/3OFF.png'\n  \t},\n     [4] = {\n    \tON = '/download.php?file=icon/Den/Downlight/4ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Downlight/4OFF.png'\n  \t},\n     [5] = {\n    \tON = '/download.php?file=icon/Den/Downlight/5ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Downlight/5OFF.png'\n  \t},\n     [6] = {\n    \tON = '/download.php?file=icon/Den/Downlight/6ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Downlight/6OFF.png'\n  \t},\n     [7] = {\n    \tON = '/download.php?file=icon/Den/Downlight/7ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Downlight/7OFF.png'\n  \t},\n     [8] = {\n    \tON = '/download.php?file=icon/Den/Downlight/8ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Downlight/8OFF.png'\n  \t}\n}\nlocal Link_ICON_TRANGTRI = {\n   [1] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/1ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/1OFF.png'\n  \t},\n   [2] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/2ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/2OFF.png'\n  \t},\n   [3] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/3ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/3OFF.png'\n  \t},\n     [4] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/4ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/4OFF.png'\n  \t},\n     [5] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/5ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/5OFF.png'\n  \t},\n     [6] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/6ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/6OFF.png'\n  \t},\n     [7] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/7ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/7OFF.png'\n  \t},\n     [8] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/8ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/8OFF.png'\n  \t},\n\t     [9] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/9ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/9OFF.png'\n  \t},\n\t     [10] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/10ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/10OFF.png'\n  \t},\n\t     [11] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/11ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/11OFF.png'\n  \t},\n\t     [12] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/12ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/12OFF.png'\n  \t},\n\t     [13] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/13ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/13OFF.png'\n  \t},\n\t     [14] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/14ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/14OFF.png'\n  \t},\n\t     [15] = {\n    \tON = '/download.php?file=icon/Den/TrangTri/15ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/TrangTri/15OFF.png'\n  \t},\n}\nlocal Link_ICON_CONGTAC = {\n   [1] = {\n    \tON = '/download.php?file=icon/Den/CongTac/1ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/CongTac/1OFF.png'\n  \t},\n   [2] = {\n    \tON = '/download.php?file=icon/Den/CongTac/2ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/CongTac/2OFF.png'\n  \t},\n   [3] = {\n    \tON = '/download.php?file=icon/Den/CongTac/3ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/CongTac/3OFF.png'\n  \t},\n     [4] = {\n    \tON = '/download.php?file=icon/Den/CongTac/4ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/CongTac/4OFF.png'\n  \t}\n}\nlocal Link_ICON_DENCHUM = {\n   [1] = {\n    \tON = '/download.php?file=icon/Den/DenChum/1ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/DenChum/1OFF.png'\n  \t}\n}\nlocal Link_ICON_LEDDAY = {\n   [1] = {\n    \tON = '/download.php?file=icon/Den/Led/1ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Led/1OFF.png'\n  \t},\n   [2] = {\n    \tON = '/download.php?file=icon/Den/Led/2ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Led/2OFF.png'\n  \t}\n}\nlocal Link_ICON_PANEL = {\n   [1] = {\n    \tON = '/download.php?file=icon/Den/Panel/1ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Panel/1OFF.png'\n  \t},\n   [2] = {\n    \tON = '/download.php?file=icon/Den/Panel/2ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Panel/2OFF.png'\n  \t},\n\t   [3] = {\n    \tON = '/download.php?file=icon/Den/Panel/3ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Panel/3OFF.png'\n  \t}\n}\nlocal Link_ICON_DENPHA = {\n   [1] = {\n    \tON = '/download.php?file=icon/Den/Pha/1ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Pha/1OFF.png'\n  \t},\n   [2] = {\n    \tON = '/download.php?file=icon/Den/Pha/2ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Pha/2OFF.png'\n  \t},\n\t   [3] = {\n    \tON = '/download.php?file=icon/Den/Pha/3ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Pha/3OFF.png'\n  \t}\n}\nlocal Link_ICON_SV = {\n   [1] = {\n    \tON = '/download.php?file=icon/Den/SV/1ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/SV/1OFF.png'\n  \t},\n   [2] = {\n    \tON = '/download.php?file=icon/Den/SV/2ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/SV/2OFF.png'\n  \t},\n\t   [3] = {\n    \tON = '/download.php?file=icon/Den/SV/3ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/SV/3OFF.png'\n  \t}\n}\nlocal Link_ICON_DENTUONG = {\n   [1] = {\n    \tON = '/download.php?file=icon/Den/Tuong/2ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Tuong/2OFF.png'\n  \t},\n\t   [2] = {\n    \tON = '/download.php?file=icon/Den/Tuong/3ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Tuong/3OFF.png'\n  \t},\n\t\t   [3] = {\n    \tON = '/download.php?file=icon/Den/Tuong/4ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Tuong/4OFF.png'\n  \t}\n}\nlocal Link_ICON_DENTUYP = {\n   [1] = {\n    \tON = '/download.php?file=icon/Den/Tuyp/1ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Tuyp/1OFF.png'\n  \t},\n   [2] = {\n    \tON = '/download.php?file=icon/Den/Tuyp/2ON.png' ,\n    \tOFF = '/download.php?file=icon/Den/Tuyp/2OFF.png'\n  \t}\n}\n--------------------------------------------------------------\n----- Lock Code ---------------------------------------------\n-----------------------------------------------------------\n\nlocal varName = {\n  [\"ICON_LIGHTING\"] = {\n    value = \"0\",\n    type = \"simple\"\n  }\n}\n\nfunction checkGlobalVariable(varName)\n-- Check if variable exist \nlocal HC2 = Net.FHttp(\"127.0.0.1\", 11111);\nfor i , v in pairs(varName) do\n\t\tresponse ,status, errorCode = HC2:POST(\"/api/globalVariables/\"..i, json.encode({\n      \tname = i,\n      \tvalue = v.value,\n      \tisEnum = 1,\n      \tenumValues = {}\n    })\n);\nif status == \"200\" or status == \"201\" then\n\n  \t\tfibaro:sleep(800);\n  \t\tresponse ,status, errorCode = HC2:PUT(\"/api/globalVariables/\"..i, json.encode({\n        name = i,\n        value = v.value,\n        isEnum = false,\n        enumValues = {}\n      })\n  );\n  \tif status == \"200\" or status == \"201\" then\n    \tfibaro:debug(\"Bi?n '\" ..i.. \"' Giá tr? : '\" ..v.value.. \"'  dã t?o thành công.\");\n  \telse\n    \tfibaro:debug(\"Uppdate - Error : \" ..status);\n  \tend\nelse\n  \tfibaro:debug(\"bi?n \"..i.. \" dã có s?n - Error : \" ..status);\nend\nend\nupdateVar = true\nend\n\n\nfunction encode(data) local b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'; return ((data:gsub('.', function(x) local r,b='',x:byte() for i=8,1,-1 do r=r..(b%2^i-b%2^(i-1)>0 and '1' or '0') end return r; end)..'0000'):gsub('%d%d%d?%d?%d?%d?', function(x) if (#x < 6) then return '' end local c=0 for i=1,6 do c=c+(x:sub(i,i)=='1' and 2^(6-i) or 0) end return b:sub(c+1,c+1) end)..({ '', '==', '=' })[#data%3+1]) end \nfunction random(nums) local i,r;r=\"\";for i=1,nums do r=r..tostring(math.random(0,9)); end; return r; end\nfunction checkSum(t) local i,b,c;c=0; for i = 1, #t do b = string.byte(t, i); if (c==0) then c = b; else c = bxor(c, b); end if (i>100) then break; end end return c; end\nfunction bxor(a, b) local x,i,r;r=0; for i = 0, 31 do x = a / 2 + b / 2; if (x~=math.floor(x)) then r = r + 2^i; end a = math.floor(a / 2); b = math.floor(b / 2); end return r; end\n\nfunction uploadIcon(login, pass, rawIconON,rawIconOFF)\n  tcp = Net.FTcpSocket(\"localhost\", 80);\n  if (not tcp) then\n    fibaro:debug(\"TCP CONNECTING WITH HC2 ERROR!\");\n    return nil;\n  end\n  boundary = \"WebKitFormBoundary0dma7LPYOUKrwpmd\";\n  enter = \"\\r\\n\";\n  content = \n    \"------\" .. boundary .. enter ..\n    \"Content-Disposition: form-data; name=\\\"type\\\"\" .. enter ..\n    enter ..\n    \"device\" .. enter ..\n    \"------\" .. boundary .. enter ..\n    \"Content-Disposition: form-data; name=\\\"redirect\\\"\" .. enter ..\n\tenter ..\n  \t\"fibaro/en/devices/icons.html?id=1&type=device\"..enter ..\n\t\"------\" .. boundary .. enter ..\n  \"Content-Disposition: form-data; name=\\\"deviceTemplate\\\"\".. enter ..\n\tenter ..\n\t\"com.fibaro.binarySwitch\".. enter ..\n \t\"------\" .. boundary .. enter ..\n    \"Content-Disposition: form-data; name=\\\"icon0\\\"; filename=\\\"iconnhan.png\\\"\" .. enter ..\n    \"Content-Type: image/png\" .. enter ..\n    enter ..\n    rawIconON .. enter ..\n    \"------\" .. boundary .. enter ..\n  \t\"Content-Disposition: form-data; name=\\\"icon100\\\"; filename=\\\"00.png\\\"\".. enter ..\n\t\"Content-Type: image/png\".. enter ..\n  \tenter ..\n  \trawIconOFF .. enter ..\n   \t\"------\" .. boundary .. \"--\" .. enter ;\n  tcp:write(\"POST /api/icons HTTP/1.1\" .. enter);\n  tcp:write(\"Host: localhost\" .. enter);\n  tcp:write(\"Content-Length: \" .. string.len(content) .. enter);\n  tcp:write(\"Authorization: Basic \" .. encode(USER..\":\"..PASSWORD) .. enter);\n  tcp:write(\"Content-Type: multipart/form-data; boundary=----\" .. boundary .. enter .. enter);\n   s = 0; for i = 1, #content do\n    b, e = tcp:write(string.char(string.byte(content, i)));\n    s = s + b;\n  end\n  status, err = tcp:read();\n  --fibaro:debug(status)\n  fibaro:debug(\"Sended \" .. s .. \" content bytes with result [\" .. err .. \"].\");\n  -- if answer is wrong\n  if (tonumber(err)>0) then\n    return nil;\n  end\n  return 0;\nend\n\n\nDebug = function ( color, message )\n  fibaro:debug(string.format('<%s style=\"color:%s;\">%s</%s>', \"span\", color, message, \"span\")); \nend\n\n--Get ICON from Server\nfunction getIconId(tcp, rawIcon)\n  -- grab icons list from api\n  response, status, errorCode = tcp:GET(\"/api/icons\");\n  -- if answer is wrong\n  if (tonumber(status)~=200) then\n    return nil;\n  -- if answer is ok?\n  else\n    -- decode text to json object\n    jsonTable = json.decode(\"[\" .. response .. \"]\");\n    -- look at device\n    iconsArray = jsonTable[1].device;\n    -- check all icons\n    for iconIndex, iconData in pairs(iconsArray) do\n     \n\t\n      if (iconData.id>=1000) and (iconData.deviceType==\"com.fibaro.binarySwitch\")  then\n\t\tlocal bien=\"/fibaro/icons/\" .. iconData.iconSetName .. \"/\" .. iconData.iconSetName .. \"100.png\";\n        r, s, e = tcp:GET(bien);\n        fibaro:debug(r..\",\"..s..\",\"..e)\n        if (s==\"200\" and e==0) then\n                    if (string.len(r)==string.len(rawIcon)) then\n            if (checkSum(r)==checkSum(rawIcon)) then\n              --fibaro:debug(\"FOUND [\" .. iconData.id .. \"]!\");\n              return iconData.id;\n            end\n          end\n        end\n      end\n    end\n  end\n  return 0;\nend\nlocal i=0;\nlocal tongden=0\ncheckGlobalVariable(varName)\nfor key,value in ipairs(Link_ICON_DEN) do\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon2=tcpSERVER:GET(value.ON);\n  fibaro:sleep(50)\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon=tcpSERVER:GET(value.OFF);\n  uploadIcon(USER, PASSWORD, icon,icon2);\n  tongden=tongden+1\n  if (i==0) then\n    \ti=1;\n\t\ttcpHC2 = Net.FHttp(\"localhost\", 80);\n\t\ttcpHC2:setBasicAuthentication(USER, PASSWORD);\n\t\tid = getIconId(tcpHC2, icon2);\n\t\tibaro:debug(\"First ID save in global ICON_LIGHTING: \".. id) \n    \tfibaro:setGlobal(\"ICON_LIGHTING\", id)\n  \tend\n  \tfibaro:sleep(100)\nend\nDebug( \"GREEN\", \"XONG DOWNLIGHT\");\nfor key,value in ipairs(Link_ICON_TRANGTRI) do\n  tcpSERVER = Net.FHttp(http, 8080); \n\ticon2=tcpSERVER:GET(value.ON);\n  fibaro:sleep(50)\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon=tcpSERVER:GET(value.OFF);\n  \t--fibaro:debug(icon)\n--Upload Icon\n  tongden=tongden+1\n\tuploadIcon(USER, PASSWORD, icon,icon2);\n  \tfibaro:sleep(100)\nend\nDebug( \"GREEN\", \"XONG TRANGTRI\");\nfor key,value in ipairs(Link_ICON_CONGTAC) do\n  tcpSERVER = Net.FHttp(http, 8080); \n\ticon2=tcpSERVER:GET(value.ON);\n  fibaro:sleep(50)\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon=tcpSERVER:GET(value.OFF);\n\tuploadIcon(USER, PASSWORD, icon,icon2);\n  tongden=tongden+1\n  fibaro:sleep(100)\nend\nDebug( \"GREEN\", \"XONG CONGTAC\");\nfor key,value in ipairs(Link_ICON_DENCHUM) do\n  tcpSERVER = Net.FHttp(http, 8080); \n\ticon2=tcpSERVER:GET(value.ON);\n  fibaro:sleep(50)\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon=tcpSERVER:GET(value.OFF);\n  uploadIcon(USER, PASSWORD, icon,icon2);\n  tongden=tongden+1\n  fibaro:sleep(100)\nend\nDebug( \"GREEN\", \"XONG DENCHUM\");\nfor key,value in ipairs(Link_ICON_LEDDAY) do\n  tcpSERVER = Net.FHttp(http, 8080); \n\ticon2=tcpSERVER:GET(value.ON);\n  fibaro:sleep(50)\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon=tcpSERVER:GET(value.OFF);\n  uploadIcon(USER, PASSWORD, icon,icon2);\n  tongden=tongden+1\n  fibaro:sleep(100)\nend\nDebug( \"GREEN\", \"XONG LEDDAY\");\nfor key,value in ipairs(Link_ICON_PANEL) do\n  tcpSERVER = Net.FHttp(http, 8080); \n\ticon2=tcpSERVER:GET(value.ON);\n  fibaro:sleep(50)\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon=tcpSERVER:GET(value.OFF);\n  uploadIcon(USER, PASSWORD, icon,icon2);\n  tongden=tongden+1\n  fibaro:sleep(100)\nend\nDebug( \"GREEN\", \"XONG PANEL\");\nfor key,value in ipairs(Link_ICON_DENPHA) do\n  tcpSERVER = Net.FHttp(http, 8080); \n\ticon2=tcpSERVER:GET(value.ON);\n  fibaro:sleep(100)\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon=tcpSERVER:GET(value.OFF);\n  uploadIcon(USER, PASSWORD, icon,icon2);\n  tongden=tongden+1\n  fibaro:sleep(500)\nend\nDebug( \"GREEN\", \"XONG DEN PHA\");\nfor key,value in ipairs(Link_ICON_SV) do\n  tcpSERVER = Net.FHttp(http, 8080); \n\ticon2=tcpSERVER:GET(value.ON);\n  fibaro:sleep(50)\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon=tcpSERVER:GET(value.OFF);\n  uploadIcon(USER, PASSWORD, icon,icon2);\n  fibaro:sleep(100)\n  tongden=tongden+1\nend\nDebug( \"GREEN\", \"XONG SAN VUON\");\nfor key,value in ipairs(Link_ICON_DENTUONG) do\n  tcpSERVER = Net.FHttp(http, 8080); \n\ticon2=tcpSERVER:GET(value.ON);\n  fibaro:sleep(50)\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon=tcpSERVER:GET(value.OFF);\n  uploadIcon(USER, PASSWORD, icon,icon2);\n  tongden=tongden+1\n  fibaro:sleep(100)\nend\nDebug( \"GREEN\", \"XONG DEN TUONG\");\nfor key,value in ipairs(Link_ICON_DENTUYP) do\n  tcpSERVER = Net.FHttp(http, 8080); \n\ticon2=tcpSERVER:GET(value.ON);\n  fibaro:sleep(50)\n  tcpSERVER = Net.FHttp(http, 8080); \n  icon=tcpSERVER:GET(value.OFF);\n  uploadIcon(USER, PASSWORD, icon,icon2);\n  tongden=tongden+1\n  fibaro:sleep(100)\nend\nDebug( \"GREEN\", \"XONG DEN TUYP\");\nDebug( \"red\", \"Hoàn Thành ! Ðã Import \"..tongden..\" Icon Thành Công\");\n--Icôn ON Lighting\n\n---------------------------------------------\n","buttonIcon":0,"favourite":false,"main":false},{"id":6,"lua":true,"waitForResponse":false,"caption":"Delete","name":"Button62","empty":false,"msg":"--------------------\n--- mHome ---------------\n--Phamj An Nhan -------------\n-- Warning: the Code will delete all User icon in relay Switch-\n------------------------------------------------------\n\nUSER = \"Kythuat@kimsontien.com\" --User HC2\nPASSWORD = \"xxxxxxxxxxxx\"    --Password HC2\n------------------------------------\n-----------------------------------\nfunction getIconId(tcp)\n  fibaro:debug(\"A\")\n  response, status, errorCode = tcp:GET(\"/api/icons\");\n  if (tonumber(status)~=200) then\n    return nil;\n  else\n    jsonTable = json.decode(\"[\" .. response .. \"]\");\n    iconsArray = jsonTable[1].device;\n    for iconIndex, iconData in pairs(iconsArray) do\n      \tfibaro:debug(iconData.id)\n      if (iconData.id>=1000) then\n        r, s, e = tcp:DELETE(\"/api/icons?id=\"..iconData.id..\"&type=device\");\n      end\n    end\n  end\nend\ntcpHC2 = Net.FHttp(\"localhost\", 80);\ntcpHC2:setBasicAuthentication(USER, PASSWORD);\ngetIconId(tcpHC2);","buttonIcon":0,"favourite":false,"main":false}]},{"type":"label","elements":[{"id":7,"lua":false,"waitForResponse":false,"caption":"Room","name":"Label3","favourite":false,"main":false}]},{"type":"button","elements":[{"id":8,"lua":true,"waitForResponse":false,"caption":"Add","name":"Button41","empty":false,"msg":"-----------------------------------\n--- mHome ------------------------\n-----------------------------------\nUSER = \"Kythuat@kimsontien.com\"\nPASSWORD = \"Chotronniemvui1\"\nlocal http=\"kimsontien.ddns.net\"\nlocal Link_ICON = {\n  [1] = '/download.php?file=icon/Room/1.png',\n  [2] = '/download.php?file=icon/Room/2.png',\n  [3] = '/download.php?file=icon/Room/3.1.png',\n  [4] = '/download.php?file=icon/Room/3.2.png',\n  [5] = '/download.php?file=icon/Room/4.1.png',\n  [6] = '/download.php?file=icon/Room/4.2.png',\n  [7] = '/download.php?file=icon/Room/5.1.png',\n  [8] = '/download.php?file=icon/Room/5.2.png',\n  [9] = '/download.php?file=icon/Room/5.png',\n  [10] = '/download.php?file=icon/Room/6.png',\n  [11] = '/download.php?file=icon/Room/7.png',\n  [12] = '/download.php?file=icon/Room/8.png',\n  [13] = '/download.php?file=icon/Room/9.png',\n  [14] = '/download.php?file=icon/Room/10.png',\n  [15] = '/download.php?file=icon/Room/11.png',\n  [16] = '/download.php?file=icon/Room/11.1.png'\n\n}\n\n--------------------------------------------------------------\n----- Lock Code ---------------------------------------------\n-----------------------------------------------------------\n\n\n\nfunction encode(data) local b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'; return ((data:gsub('.', function(x) local r,b='',x:byte() for i=8,1,-1 do r=r..(b%2^i-b%2^(i-1)>0 and '1' or '0') end return r; end)..'0000'):gsub('%d%d%d?%d?%d?%d?', function(x) if (#x < 6) then return '' end local c=0 for i=1,6 do c=c+(x:sub(i,i)=='1' and 2^(6-i) or 0) end return b:sub(c+1,c+1) end)..({ '', '==', '=' })[#data%3+1]) end \nfunction random(nums) local i,r;r=\"\";for i=1,nums do r=r..tostring(math.random(0,9)); end; return r; end\nfunction checkSum(t) local i,b,c;c=0; for i = 1, #t do b = string.byte(t, i); if (c==0) then c = b; else c = bxor(c, b); end if (i>100) then break; end end return c; end\nfunction bxor(a, b) local x,i,r;r=0; for i = 0, 31 do x = a / 2 + b / 2; if (x~=math.floor(x)) then r = r + 2^i; end a = math.floor(a / 2); b = math.floor(b / 2); end return r; end\n\nfunction uploadIcon(login, pass, rawIconON)\n  tcp = Net.FTcpSocket(\"localhost\", 80);\n  if (not tcp) then\n    fibaro:debug(\"TCP CONNECTING WITH HC2 ERROR!\");\n    return nil;\n  end\n  boundary = \"WebKitFormBoundary0dma7LPYOUKrwpmd\";\n  enter = \"\\r\\n\";\n  content = \n    \"------\" .. boundary .. enter ..\n    \"Content-Disposition: form-data; name=\\\"type\\\"\" .. enter ..\n    enter ..\n    \"room\" .. enter ..\n    \"------\" .. boundary .. enter ..\n    \"Content-Disposition: form-data; name=\\\"redirect\\\"\" .. enter ..\n\tenter ..\n  \t\"fibaro/en/devices/icons.html?id=1&type=room\"..enter ..\n \t\"------\" .. boundary .. enter ..\n    \"Content-Disposition: form-data; name=\\\"icon0\\\"; filename=\\\"iconnhan.png\\\"\" .. enter ..\n    \"Content-Type: image/png\" .. enter ..\n    enter ..\n    rawIconON .. enter ..\n   \t\"------\" .. boundary .. \"--\" .. enter ;\n  tcp:write(\"POST /api/icons HTTP/1.1\" .. enter);\n  tcp:write(\"Host: localhost\" .. enter);\n  tcp:write(\"Content-Length: \" .. string.len(content) .. enter);\n  tcp:write(\"Authorization: Basic \" .. encode(USER..\":\"..PASSWORD) .. enter);\n  tcp:write(\"Content-Type: multipart/form-data; boundary=----\" .. boundary .. enter .. enter);\n   s = 0; for i = 1, #content do\n    b, e = tcp:write(string.char(string.byte(content, i)));\n    s = s + b;\n  end\n  status, err = tcp:read();\n  --fibaro:debug(status)\n  fibaro:debug(\"Sended \" .. s .. \" content bytes with result [\" .. err .. \"].\");\n  -- if answer is wrong\n  if (tonumber(err)>0) then\n    return nil;\n  end\n  return 0;\nend\n\n\nDebug = function ( color, message )\n  fibaro:debug(string.format('<%s style=\"color:%s;\">%s</%s>', \"span\", color, message, \"span\")); \nend\n\n--Get ICON from Server\n\nlocal i=0;\nfor key,value in ipairs(Link_ICON) do\n  \ttcpSERVER = Net.FHttp(http, 8080); \n\ticon2=tcpSERVER:GET(value);\n\tuploadIcon(USER, PASSWORD, icon2);\n  \tfibaro:sleep(100)\nend\nDebug( \"red\", \"Hoàn Thành\");\n--Icôn ON Lighting\n\n---------------------------------------------\n","buttonIcon":1145,"favourite":false,"main":false},{"id":9,"lua":true,"waitForResponse":false,"caption":"Delete","name":"Button42","empty":false,"msg":"--------------------\n--- mHome ---------------\n--Phamj An Nhan -------------\n-- Warning: the Code will delete all User icon in Room-\n------------------------------------------------------\n\nUSER = \"Kythuat@kimsontien.com\" --User HC2\nPASSWORD = \"xxxxxxxxxxxx\"    --Password HC2\n\n-----------------------------\n-------LOCK-----------------\n-------------------------------\n\nfunction getIconId(tcp)\n  fibaro:debug(\"A\")\n  response, status, errorCode = tcp:GET(\"/api/icons\");\n  if (tonumber(status)~=200) then\n    return nil;\n  else\n    jsonTable = json.decode(\"[\" .. response .. \"]\");\n    iconsArray = jsonTable[1].room;\n    for iconIndex, iconData in pairs(iconsArray) do\n      \tfibaro:debug(iconData.id)\n      if (iconData.id>=1000) then\n        r, s, e = tcp:DELETE(\"/api/icons?id=\"..iconData.id..\"&type=room\");\n      end\n    end\n  end\nend\ntcpHC2 = Net.FHttp(\"localhost\", 80);\ntcpHC2:setBasicAuthentication(USER, PASSWORD);\ngetIconId(tcpHC2);","buttonIcon":0,"favourite":false,"main":false}]},{"type":"label","elements":[{"id":10,"lua":false,"waitForResponse":false,"caption":"Icon","name":"Label4","favourite":false,"main":false}]},{"type":"button","elements":[{"id":11,"lua":true,"waitForResponse":false,"caption":"Downlight","name":"Button411","empty":false,"msg":"------------------------------------\n-- mHome          --------------------\n-- Phạm An Nhàn  -------------------\n-----------------------------------\n\nlocal id_sw={72,10,12,18}\nlocal icon=fibaro:getGlobal(\"ICON_LIGHTING\")\n\n-----------------------------\n-------LOCK-----------------\n-------------------------------\n\n\nDebug = function ( color, message )\n  fibaro:debug(string.format('<%s style=\"color:%s;\">%s</%s>', \"span\", color, message, \"span\")); \nend\n\nfor var=1,#sw do\n  HC2 =Net.FHttp(\"127.0.0.1\", 11111);\n  response, status, errorCode = HC2:PUT(\"/api/devices/\"..id_sw[var], \"{\\\"id\\\":\"..id_sw[var]..\",\\\"properties\\\":{\\\"deviceIcon\\\":\"..icon..\"}}\") \nend\nDebug( \"red\", \"Hoàn Thành\");","buttonIcon":0,"favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}